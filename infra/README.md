# DevOps Stage 6 - Infrastructure Documentation

## üèóÔ∏è Infrastructure Overview

This directory contains all infrastructure-as-code (IaC) for the DevOps Stage 6 TODO application deployment.

## üìÅ Directory Structure

```
infra/
‚îú‚îÄ‚îÄ terraform/              # Infrastructure provisioning
‚îÇ   ‚îú‚îÄ‚îÄ main.tf            # Root module orchestration
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf       # Input variables
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf         # Output values
‚îÇ   ‚îú‚îÄ‚îÄ providers.tf       # AWS provider config
‚îÇ   ‚îú‚îÄ‚îÄ backend.tf         # Remote state config
‚îÇ   ‚îú‚îÄ‚îÄ modules/           # Terraform modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ networking/    # VPC, subnets, security groups
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compute/       # EC2 instances
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ provisioner/   # Ansible trigger
‚îÇ   ‚îî‚îÄ‚îÄ templates/         # Template files
‚îÇ       ‚îî‚îÄ‚îÄ inventory.tpl  # Ansible inventory template
‚îî‚îÄ‚îÄ ansible/               # Configuration management
    ‚îú‚îÄ‚îÄ playbook.yml       # Main playbook
    ‚îú‚îÄ‚îÄ inventory/         # Dynamic inventory (generated by Terraform)
    ‚îî‚îÄ‚îÄ roles/
        ‚îú‚îÄ‚îÄ dependencies/  # Install Docker, Git, etc.
        ‚îî‚îÄ‚îÄ deploy/        # Deploy application
```

## Quick Start

### Prerequisites

1. **AWS Account** with appropriate credentials
2. **Terraform** >= 1.6.0
3. **Ansible** >= 2.9
4. **SSH Key Pair** for server access
5. **Domain Name** configured (e.g., destinyobs.mooo.com)

### Initial Setup

1. **Configure Terraform variables:**
   ```bash
   cd infra/terraform
   cp terraform.tfvars.example terraform.tfvars
   # Edit terraform.tfvars with your values
   ```

2. **Initialize Terraform:**
   ```bash
   terraform init
   ```

3. **Plan infrastructure:**
   ```bash
   terraform plan
   ```

4. **Apply infrastructure:**
   ```bash
   terraform apply -auto-approve
   ```

This single command will:
- Provision VPC, subnet, security groups
- Launch EC2 instance
- Generate Ansible inventory
- Install dependencies (Docker, Git, etc.)
- Deploy application with Docker Compose
- Configure Traefik with SSL

## Security Features

### Drift Detection
The infrastructure includes automated drift detection:
- Runs `terraform plan` on every infra change
- Detects configuration drift
- Sends email notification when drift is detected
- Pauses for manual approval before applying changes
- Auto-applies if no drift detected

### Idempotency
All resources are designed to be idempotent:
- Re-running `terraform apply` does nothing if no changes
- No resource recreation unless necessary
- Ansible playbooks can run multiple times safely

## üìß Email Notifications

Configure GitHub Secrets for email alerts:
- `SMTP_USERNAME` - Gmail address
- `SMTP_PASSWORD` - Gmail app password
- `NOTIFICATION_EMAIL` - Recipient email

## üîÑ CI/CD Workflows

### Infrastructure Workflow (`infra-deploy.yml`)
Triggers on changes to:
- `infra/terraform/**`
- `infra/ansible/**`

Steps:
1. Terraform Plan
2. Drift Detection
3. Email Alert (if drift detected)
4. Manual Approval (if drift)
5. Terraform Apply
6. Success/Failure Notification

### Application Workflow (`app-deploy.yml`)
Triggers on changes to:
- Service folders (`frontend/`, `auth-api/`, etc.)
- `docker-compose.yml`

Steps:
1. Run Ansible with `deploy` tag
2. Pull latest code
3. Rebuild containers
4. Verify deployment
5. Send notification

## üõ†Ô∏è Manual Operations

### Deploy Only Dependencies
```bash
cd infra/ansible
ansible-playbook -i inventory/hosts.yml playbook.yml --tags dependencies
```

### Deploy Only Application
```bash
cd infra/ansible
ansible-playbook -i inventory/hosts.yml playbook.yml --tags deploy
```

### Destroy Infrastructure
```bash
cd infra/terraform
terraform destroy
```

## Terraform Outputs

After successful apply, you'll see:
- `instance_public_ip` - Server IP address
- `application_url` - Full HTTPS URL
- `ssh_connection` - SSH command to connect
- `ansible_inventory_path` - Path to inventory file

## üêõ Troubleshooting

### SSH Connection Issues
```bash
# Test SSH connectivity
ssh -i ~/.ssh/id_rsa ubuntu@<instance_ip>
```

### Ansible Fails
```bash
# Run with verbose output
ansible-playbook -i inventory/hosts.yml playbook.yml -vvv
```

### Drift Detected But No Changes Made
This is normal if:
- Tags were manually added/removed
- User data was modified
- Resources were manually altered

Review the plan output and approve if changes are acceptable.

## üìù Required GitHub Secrets

Set these in your GitHub repository:
- `AWS_ACCESS_KEY_ID` - AWS access key
- `AWS_SECRET_ACCESS_KEY` - AWS secret key
- `SSH_PRIVATE_KEY` - Private key for server access
- `SERVER_IP` - Server IP (for app-deploy workflow)
- `SMTP_USERNAME` - Email username
- `SMTP_PASSWORD` - Email password
- `NOTIFICATION_EMAIL` - Alert recipient email

## Key Features

**Modular Terraform** - Clean module structure
**Drift Detection** - Automatic detection with email alerts
**Idempotent** - Safe to run multiple times
**Automated Deployment** - Single command setup
**CI/CD Integration** - Separate infra and app pipelines
**Email Notifications** - Stay informed of changes
**Security Groups** - Properly configured firewall rules
**SSL/HTTPS** - Automatic certificate management
**Remote State** - S3 backend with state locking

## üìÖ Maintenance

- **Daily**: Monitor drift detection emails
- **Weekly**: Review Terraform state and AWS console for anomalies
- **Monthly**: Update dependencies and Terraform providers
- **As Needed**: Scale instance type or adjust security rules
