---
# Deploy Role - Clone repo, deploy application

- name: Ensure application directory exists
  file:
    path: "{{ app_directory | dirname }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0755'
  become: yes

- name: Check if repository exists
  stat:
    path: "{{ app_directory }}/.git"
  register: repo_exists

- name: Clone application repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ app_directory }}"
    version: main
    force: no
  become: yes
  when: not repo_exists.stat.exists

- name: Set ownership of cloned repository
  file:
    path: "{{ app_directory }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    recurse: yes
  become: yes
  when: not repo_exists.stat.exists

- name: Pull latest changes from repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ app_directory }}"
    version: main
    force: no
  become: yes
  register: git_pull
  when: repo_exists.stat.exists

- name: Set ownership after pull
  file:
    path: "{{ app_directory }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    recurse: yes
  become: yes
  when: repo_exists.stat.exists and git_pull.changed

- name: Create Traefik certificates directory in app
  file:
    path: "{{ app_directory }}/traefik/letsencrypt"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0755'
  become: yes

- name: Ensure acme.json exists in app directory
  file:
    path: "{{ app_directory }}/traefik/letsencrypt/acme.json"
    state: touch
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0600'
  become: yes

- name: Check if users-api JAR needs building
  stat:
    path: "{{ app_directory }}/users-api/target/*.jar"
  register: users_api_jar

- name: Build users-api JAR with Maven
  command: ./mvnw clean package -DskipTests
  args:
    chdir: "{{ app_directory }}/users-api"
  become: yes
  become_user: "{{ deploy_user }}"
  environment:
    JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64
    PATH: "/usr/lib/jvm/java-8-openjdk-amd64/bin:{{ ansible_env.PATH }}"
    HOME: "/home/{{ deploy_user }}"
  when: not users_api_jar.stat.exists or git_pull.changed

- name: Set ownership of built JAR
  file:
    path: "{{ app_directory }}/users-api/target"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    recurse: yes
  become: yes
  when: not users_api_jar.stat.exists or git_pull.changed

- name: Stop existing containers (if any)
  command: docker compose down
  args:
    chdir: "{{ app_directory }}"
  become: yes
  become_user: "{{ deploy_user }}"
  ignore_errors: yes

- name: Build and start Docker containers
  command: docker compose up -d --build
  args:
    chdir: "{{ app_directory }}"
  become: yes
  become_user: "{{ deploy_user }}"
  register: docker_compose_up

- name: Wait for services to be healthy
  pause:
    seconds: 30

- name: Check running containers
  command: docker compose ps
  args:
    chdir: "{{ app_directory }}"
  become: yes
  become_user: "{{ deploy_user }}"
  register: container_status
  changed_when: false

- name: Display container status
  debug:
    msg: "{{ container_status.stdout_lines }}"

- name: Verify application is accessible
  uri:
    url: "https://{{ domain_name }}"
    validate_certs: no
    status_code: 200
  register: app_health
  retries: 5
  delay: 10
  until: app_health.status == 200
  ignore_errors: yes

- name: Display deployment result
  debug:
    msg: "Application deployed successfully at https://{{ domain_name }}"
  when: app_health.status == 200